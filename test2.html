<!DOCTYPE html>
<html>

<head>
    <meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no' />
    <script src='./js/mapbox-src.js'></script>
    <link href='./js/mapbox.css' rel='stylesheet' />
    <!--[if lte IE 8]>
    <link href='http://api.tiles.mapbox.com/mapbox.js/v1.0.2/mapbox.ie.css' rel='stylesheet' >
    <![endif]-->
    <style>
    body {
        margin:0;
        padding:0;
    }
    #map {
        position:absolute;
        top:0;
        bottom:0;
        width:100%;
    }
    #z {
        top: 75px;
        left: 10px;
        position: absolute;
        z-index: 999;
    }
    #zoom-bar {
        width: 25px;
        position: relative;
        height: 200px;
        background: #FFF;
        border: 1px solid #BBB;
        -webkit-border-radius: 3px;
        border-radius: 3px;
    }
    .dragdealer .handle {
        position: absolute;
        cursor: pointer;
        width: 25px;
        height: 30px;
        background: #222;
        color: #fff;
        font-weight: bold;
        line-height: 30px;
        text-align: center;
    }
    </style>
</head>

<body>
    <link rel="stylesheet" href="./assets/Leaflet.markercluster/MarkerCluster.css" />
    <link rel="stylesheet" href="./assets/Leaflet.markercluster/MarkerCluster.Default.css" />
    <link rel="stylesheet" href="css/classic.css" />
    <link rel="stylesheet" href="css/app.css" />
    <link rel="stylesheet" href="./assets/dragdealer/dragdealer.css" />
    <link rel='stylesheet' href="./js/jquery-ui.css" />
    <!--[if lte IE 8]>
    <link rel="stylesheet" href="/assets/Leaflet.markercluster/MarkerCluster.Default.ie.css" />
    <![endif]-->
    <script src="./assets/Leaflet.markercluster/leaflet.markercluster-src.js"></script>
    <script src="./js/jquery-2.0.2.js"></script>
    <script src="./js/SliderControl.js"></script>
    <script src="./js/jquery-ui.js"></script>
    <script src="./js/jQDateRangeControl.js"></script>
    <script src="./js/jQDateRangeSlider-min.js"></script>
    <script src="./assets/dragdealer/dragdealer.js"></script>

    <div id='z'>
        <div id='zoom-bar' class='dragdealer'>
            <div id='handle' class="handle">0</div>
        </div>
    </div>

    <div id='map'></div>
    <script type='text/javascript'>
    var map = L.mapbox.map('map', 'eckemp.map-k87gbmbm', {
        center: [37.54, -77.43],
        zoom: 8,
        minZoom: 3,
        maxZoom: 13
    });
    var markers = new L.MarkerClusterGroup();
    var allLayers = new Array();
    var myGeoData;
    var firstYear = 1993;
    var lastYear = 2012;
    var prevYear = firstYear;
    var currYear = firstYear;
    var zooms = 10;
    var handle = document.getElementById('handle');

    $.when(
        $.getJSON('./data/geojson/all.geojson', function(data) {
            myGeoData = data;
        })
    ).done(initMap);

    function setMap(start, end) {
        for (var i = start; i <= end; i++) {
            allLayers[i] = L.geoJson(myGeoData, {
                onEachFeature: function(feature, layer) {
                    layer.bindPopup(feature.properties['grad-year'] + "<br>" + feature.properties.hometown + "<br>" + feature.properties.college);
                },
                filter: function(feature, layer) {
                    return feature.properties['grad-year'] === i.toString();
                }
            });
            allLayers[i].on('mouseover', function(e) {
                e.layer.openPopup();
            });
            allLayers[i].on('mouseout', function(e) {
                e.layer.closePopup();
            });
        }
    }

    function initMap() {
        // Configure Dragdealer to update the map zoom
        var zoom_bar = new Dragdealer('zoom-bar', {
            steps: zooms,
            snap: true,
            horizontal: false,
            vertical: true,
            callback: function(x, y) {
                var z = y * (zooms - 1);
                map.setZoom(z);
                handle.innerHTML = z;
            }
        });

        // Round zoom so that numbers in the bar look presentable.
        map.on('zoomend', function() {
            var z = Math.round(map.getZoom());
            zoom_bar.setValue(3, z / 13);
            handle.innerHTML = z;
        });
        // Init zoom_bar
        map.fireEvent('zoomend');

        setMap(firstYear, lastYear);
        for (var i = lastYear - 10; i <= lastYear - 5; i++) {
            markers.addLayer(allLayers[i.toString()]);
        }
        map.addLayer(markers);

        //Now add our control to the map
        var control = new L.Control.DateSlider().addTo(map);

        $("#dateSlider").on("valuesChanged", function(e, data) {
            resetMap(data.values.min.getFullYear(), data.values.max.getFullYear());
        });
        //resetMap();
        //map.fitBounds(markers.getBounds());
    }

    function resetMap(min, max) {
        markers.clearLayers();
        for (var i = min; i <= max; i++) {
            markers.addLayer(allLayers[i.toString()]);
        }
    }
    </script>
</body>

</html>
