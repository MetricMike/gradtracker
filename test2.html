<!DOCTYPE html>
<html>

<head>
    <meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no' />
    <script src='./js/mapbox-src.js'></script>
    <link href='./js/mapbox.css' rel='stylesheet' />
    <!--[if lte IE 8]>
    <link href='http://api.tiles.mapbox.com/mapbox.js/v1.0.2/mapbox.ie.css' rel='stylesheet' >
    <![endif]-->
    <style>
    body {
        margin:0;
        padding:0;
    }
    #map {
        position:absolute;
        top:0;
        bottom:0;
        width:100%;
    }
    .uiContainer {
        display: flex;
    }
    .btn {
        margin-top: 40px;
    }
    #map-ui {
        position: absolute;
        top: 10px;
        right: 10px;
        z-index: 100;
    }
    #map-ui ul {
        list-style: none;
        margin: 0;
        padding: 0;
    }
    #map-ui li:last-child a {
        border-bottom-width: 1px;
        -webkit-border-radius: 0 0 3px 3px;
        border-radius: 0 0 3px px;
    }
    #map-ui li:first-child a {
        -webkit-border-radius: 3px 3px 0 0;
        border-radius: 3px 3px 0 0;
    }
    #map-ui a.active {
        background: #3887BE;
        border-color: #3887BE;
        color: #FFF;
    }
    </style>
</head>

<body>
    <link rel="stylesheet" href="./assets/Leaflet.markercluster/MarkerCluster.css" />
    <link rel="stylesheet" href="./assets/Leaflet.markercluster/MarkerCluster.Default.css" />
    <link rel="stylesheet" href="./js/jquery-ui.css" />
    <link rel="stylesheet" href="./css/iThing.css" />
    <link href="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/css/bootstrap-combined.no-icons.min.css" rel="stylesheet">
    <link href="//netdna.bootstrapcdn.com/font-awesome/3.2.1/css/font-awesome.css" rel="stylesheet">
    <!--[if lte IE 8]>
    <link rel="stylesheet" href="/assets/Leaflet.markercluster/MarkerCluster.Default.ie.css" />
    <![endif]-->
    <script src="./assets/Leaflet.markercluster/leaflet.markercluster-src.js"></script>
    <script src="./js/jquery-2.0.2.js"></script>
    <script src="./js/jquery-ui.js"></script>
    <script src="./js/jQDateRangeSlider-withRuler-min.js"></script>


    <div id='map-ui'>
        <ul>
            <li><a href='#' class='active' id='filter-westhampton'>Show Westhampton Alumni</a>
            </li>
            <li><a href='#' class='active' id='filter-richmond'>Show Richmond Alumni</a>
            </li>
            <li><a href='#' class='active' id='filter-all'>Show All Alumni</a>
            </li>
        </ul>
    </div>
    <div id='map'></div>

    <script type='text/javascript'>
    var map = L.mapbox.map('map', 'eckemp.map-k87gbmbm', {
        center: [37.54, -77.43],
        zoom: 8,
        minZoom: 3,
        maxZoom: 13
    });
    var markers = new L.MarkerClusterGroup();
    var allLayers = new Array();
    var myGeoData;
    var firstYear = 1993;
    var lastYear = 2012;
    var prevYear = firstYear;
    var currYear = firstYear;

    var MyControlSlider = L.Control.extend({
        options: {
            position: 'bottomleft'
        },

        onAdd: function(map) {
            var uiContainer = L.DomUtil.create('div', 'uiContainer');
            var toggleContainer = L.DomUtil.create('button', 'btn', uiContainer);
            var iconContainer = L.DomUtil.create('i', 'icon-play', toggleContainer);
            var sliderContainer = L.DomUtil.create('div', 'slider', uiContainer);

            $(uiContainer).mousedown(function() {
                map.dragging.disable();
            });
            $(document).mouseup(function() {
                map.dragging.enable();
            });

            $(sliderContainer).dateRangeSlider({
                bounds: {
                    min: new Date(firstYear, 0, 1),
                    max: new Date(lastYear, 11, 31)
                },
                defaultValues: {
                    min: new Date(firstYear + (lastYear - firstYear) / 3, 0, 1),
                    max: new Date(lastYear - (lastYear - firstYear) / 3, 11, 31)
                },
                formatter: function(val) {
                    return val.getFullYear();
                },
                step: {
                    years: 1
                },
                scales: [{
                    next: function(value) {
                        var next = new Date(value);
                        return new Date(next.setYear(value.getFullYear() + 5));
                    },
                    label: function(value) {
                        return value.getFullYear();
                    }
                }]
            });

            return uiContainer;
        }
    });

    map.addControl(new MyControlSlider());

    $("button").click(function() {
        if ($("i").hasClass("icon-play")) {
            $("i").switchClass("icon-play", "icon-stop");

            $(".ui-rangeSlider-bar").clone().attr("id", "animated-bar").css({
                width: 0,
                "background-color": "#33cc00",
                transition: "all 1s"
            }).appendTo(".ui-rangeSlider-container");

            var width = parseFloat($(".ui-rangeSlider-bar").css("width"));
            var sliderValues = $(".slider").dateRangeSlider("values");
            sliderValues.min = sliderValues.min.getFullYear();
            sliderValues.max = sliderValues.max.getFullYear();
            var diff = sliderValues.max - sliderValues.min;
            var partWidth = width / diff;
            var i = 0;
            var currYear = sliderValues.min;

            function animate() {
                if (i < width) {
                    i += partWidth;
                    currYear++;
                    $("#animated-bar").css("width", i);
                    resetMap(sliderValues.min, currYear);
                    console.log("Moved animated-bar " + i + " pixels.");
                    setTimeout(animate, 1000);
                } else { // already moved to max
                    $("button").click();
                }
            }

            animate();
        } else if ($("i").hasClass("icon-stop")) {
            $("i").switchClass("icon-stop", "icon-play");
            $("#animated-bar").remove();
        }
    });

    $.when(
        $.getJSON('./data/geojson/all.geojson', function(data) {
            myGeoData = data;
        })
    ).done(initMap);

    function setMap(start, end) {
        for (var i = start; i <= end; i++) {
            allLayers[i] = L.geoJson(myGeoData, {
                onEachFeature: function(feature, layer) {
                    layer.bindPopup(feature.properties['grad-year'] + "<br>" + feature.properties.hometown + "<br>" + feature.properties.college);
                },
                filter: function(feature, layer) {
                    return feature.properties['grad-year'] === i.toString();
                }
            });
            allLayers[i].on('mouseover', function(e) {
                e.layer.openPopup();
            });
            allLayers[i].on('mouseout', function(e) {
                e.layer.closePopup();
            });
        }
    }

    $("#filter-westhampton").click(function() {
        $("#filter-westhampton").addClass("active");
        $("#filter-richmond").removeClass("active");
        $("#filter-all").removeClass("active");

        $.each(allLayers, function(key, value) {
            value = L.geoJson(myGeoData, {
                filter: function(feature, layer) {
                    return (feature.properties['grad-year'] === key.toString()) && (feature.properties['college'] === "Westhampton");
                }
            });
        })
    });

    $("#filter-richmond").click(function() {
        $("#filter-richmond").addClass("active");
        $("#filter-westhampton").removeClass("active");
        $("#filter-all").removeClass("active");

        $.each(allLayers, function(key, value) {
            value = L.geoJson(myGeoData, {
                filter: function(feature, layer) {
                    return (feature.properties['grad-year'] === key.toString()) && (feature.properties['college'] === "Richmond");
                }
            });
        })
    });

    $("#filter-all").click(function() {
        $("#filter-all").addClass("active");
        $("#filter-richmond").removeClass("active");
        $("#filter-westhampton").removeClass("active");

        $.each(allLayers, function(key, value) {
            value = L.geoJson(myGeoData, {
                filter: function(feature, layer) {
                    return feature.properties['grad-year'] === key.toString();
                }
            });
        })
    });

    function initMap() {
        setMap(firstYear, lastYear);
        for (var i = lastYear - 10; i <= lastYear - 5; i++) {
            markers.addLayer(allLayers[i.toString()]);
        }
        map.addLayer(markers);

        //Now add our control to the map
        //var control = new L.Control.DateSlider().addTo(map);

        $(".slider").on("valuesChanged", function(e, data) {
            resetMap(data.values.min.getFullYear(), data.values.max.getFullYear());
        });
        //resetMap();
        //map.fitBounds(markers.getBounds());
    }

    function resetMap(min, max) {
        markers.clearLayers();
        for (var i = min; i <= max; i++) {
            markers.addLayer(allLayers[i.toString()]);
        }
    }
    </script>
</body>

</html>
