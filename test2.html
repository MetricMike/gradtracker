<!DOCTYPE html>
<html>

<head>
    <meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no' />
    <script src='./js/mapbox-src.js'></script>
    <link href='./js/mapbox.css' rel='stylesheet' />
    <!--[if lte IE 8]>
    <link href='http://api.tiles.mapbox.com/mapbox.js/v1.0.2/mapbox.ie.css' rel='stylesheet' >
    <![endif]-->
    <style>
    body {
        margin:0;
        padding:0;
    }
    #map {
        position:absolute;
        top:0;
        bottom:0;
        width:100%;
    }
    </style>
</head>

<body>
    <link rel="stylesheet" href="./assets/Leaflet.markercluster/MarkerCluster.css" />
    <link rel="stylesheet" href="./assets/Leaflet.markercluster/MarkerCluster.Default.css" />
    <link rel="stylesheet" href="./js/jquery-ui.css" />
    <link rel="stylesheet" href="./css/iThing.css" />
    <!--[if lte IE 8]>
    <link rel="stylesheet" href="/assets/Leaflet.markercluster/MarkerCluster.Default.ie.css" />
    <![endif]-->
    <script src="./assets/Leaflet.markercluster/leaflet.markercluster-src.js"></script>
    <script src="./js/jquery-2.0.2.js"></script>
    <script src="./js/jquery-ui.js"></script>
    <script src="./js/jQDateRangeSlider-withRuler-min.js"></script>

    <div id='map'></div>
    <div id='ui-overlay'>
        <div id="slider"></div>
    </div>

    <script type='text/javascript'>
    var map = L.mapbox.map('map', 'eckemp.map-k87gbmbm', {
        center: [37.54, -77.43],
        zoom: 8,
        minZoom: 3,
        maxZoom: 13
    });
    var markers = new L.MarkerClusterGroup();
    var allLayers = new Array();
    var myGeoData;
    var firstYear = 1993;
    var lastYear = 2012;
    var prevYear = firstYear;
    var currYear = firstYear;

    $.when(
        $.getJSON('./data/geojson/all.geojson', function(data) {
            myGeoData = data;
        })
    ).done(initMap);

    function setMap(start, end) {
        for (var i = start; i <= end; i++) {
            allLayers[i] = L.geoJson(myGeoData, {
                onEachFeature: function(feature, layer) {
                    layer.bindPopup(feature.properties['grad-year'] + "<br>" + feature.properties.hometown + "<br>" + feature.properties.college);
                },
                filter: function(feature, layer) {
                    return feature.properties['grad-year'] === i.toString();
                }
            });
            allLayers[i].on('mouseover', function(e) {
                e.layer.openPopup();
            });
            allLayers[i].on('mouseout', function(e) {
                e.layer.closePopup();
            });
        }
    }

    function initMap() {
        setMap(firstYear, lastYear);
        for (var i = lastYear - 10; i <= lastYear - 5; i++) {
            markers.addLayer(allLayers[i.toString()]);
        }
        map.addLayer(markers);

        /*/Now add our control to the map
        var control = new L.Control.DateSlider().addTo(map);

        $("#dateSlider").on("valuesChanged", function(e, data) {
            resetMap(data.values.min.getFullYear(), data.values.max.getFullYear());
        });*/
        //resetMap();
        //map.fitBounds(markers.getBounds());
    }

    function resetMap(min, max) {
        markers.clearLayers();
        for (var i = min; i <= max; i++) {
            markers.addLayer(allLayers[i.toString()]);
        }
    }

    $("#slider").dateRangeSlider({
        bounds: {
            min: new Date(firstYear, 0, 1),
            max: new Date(lastYear, 11, 31)
        },
        defaultValues: {
            min: new Date(firstYear + (lastYear - firstYear) / 3, 0, 1),
            max: new Date(lastYear - (lastYear - firstYear) / 3, 11, 31)
        },
        formatter: function(val) {
            return val.getFullYear();
        },
        step: {
            years: 1
        },
        scales: [{
            first: function(value) {
                return value;
            },
            end: function(value) {
                return value;
            },
            next: function(value) {
                var next = new Date(value);
                return new Date(next.setYear(value.getFullYear() + 1));
            },
            label: function(value) {
                return value.getFullYear();
            },
            format: function(tickContainer, tickStart, tickEnd) {
                tickContainer.addClass("myCustomClass");
            }
        }]
    });
    </script>
</body>

</html>
